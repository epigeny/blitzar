<template>
	<div class="code-block-component">
    <NTabs
			v-if="importComponentInstanceFn"
			class="code-block-component__tabs" type="line" :tabsPadding="16" paneStyle="padding: 0"
			default-value="example"
		>
			<NTabPane v-if="component" name="example" tab="Example" class="expand">
				<div class="code-block-component__component">
					<component :is="component"></component>
				</div>
			</NTabPane>
			<NTabPane v-if="template" name="template" tab="Template">
				<Prism style="margin: 0">{{ template }}</Prism>
			</NTabPane>
			<NTabPane v-if="script" name="script" tab="Script">
				<Prism style="margin: 0">{{ script }}</Prism>
			</NTabPane>
			<NTabPane v-if="style" name="style" tab="Style">
				<Prism style="margin: 0">{{ style }}</Prism>
			</NTabPane>
		</NTabs>
	</div>
</template>

<script>
import { computed, ref, shallowRef, defineAsyncComponent } from 'vue'
import { parseComponent } from 'vue-sfc-parser'
import { NConfigProvider, NTabs, NTabPane, darkTheme } from 'naive-ui'

if (!import.meta.env.SSR) {
  window.Prism = window.Prism || {}
  Prism.manual = true
}

export default {
  components: {
    NTabs,
    NTabPane,
    NConfigProvider,
    Prism: defineAsyncComponent(() => import('./Prism.vue'))
  },
  props: {
    title: {
      type: String,
      default: ''
    },
    importComponentInstanceFn: {
      type: [Function, Boolean],
      default: false
    },
    importComponentRawFn: {
      type: [Function, Boolean],
      default: false
    },
    isDark: {
      type: Boolean,
      default: false
    }
  },
  setup(props) {
    const theme = computed(() => {
      return props.isDark ? darkTheme : null
    })

    const component = shallowRef(null)

    props.importComponentInstanceFn &&
      props.importComponentInstanceFn().then(res => {
        component.value = res.default
      })

    const template = ref('')
    const script = ref('')
    const style = ref('')

    props.importComponentRawFn &&
      props.importComponentRawFn().then(res => {
        const SFC = parseComponent(res.default)

        template.value = `<${SFC.template.type}${Object.keys(SFC.template.attrs).reduce((acc, cur) => {
          if (typeof SFC.template.attrs[cur] === 'boolean') {
            acc += ` ${cur}`
          } else {
            acc += ` ${cur}="${SFC.template.attrs[cur]}"`
          }
          return acc
        }, '')}>${SFC.template.content}</${SFC.template.type}>`

        script.value = `<${SFC.script.type}${Object.keys(SFC.script.attrs).reduce((acc, cur) => {
          if (typeof SFC.script.attrs[cur] === 'boolean') {
            acc += ` ${cur}`
          } else {
            acc += ` ${cur}="${SFC.script.attrs[cur]}"`
          }
          return acc
        }, '')}>${SFC.script.content}</${SFC.script.type}>`

        style.value = SFC.styles.reduce((acc, cur) => {
          acc += `<${cur.type}${Object.keys(cur.attrs).reduce((a, c) => {
            if (typeof cur.attrs[c] === 'boolean') {
              a += ` ${c}`
            } else {
              a += ` ${c}="${cur.attrs[c]}"`
            }
            return a
          }, '')}>${cur.content}</${cur.type}>\n\n`
          return acc
        }, '')
      })

    return {
      theme,
      component,
      template,
      script,
      style
    }
  }
}
</script>

<style>
.code-block-component {
  --c-active: #42b983;
  --c-text: #1f2225;
  --c-border: #efeff5;
  min-height: 100px;
  border: thin solid var(--c-border);
  border-radius: 6px;
  overflow: hidden;
}

.code-block-component	.code-block-component__tabs {
	--tab-text-color-active: var(--c-active) !important;
	--bar-color: var(--c-active) !important;
	--tab-text-color-hover: var(--c-active) !important;
	--tab-text-color: var(--c-text) !important;
	--tab-border-color: var(--c-border) !important;
}

.code-block-component .code-block-component__component {
  padding: 1rem;
}
</style>
